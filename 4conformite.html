<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compliance Passport - International & Events</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- CORE STYLES --- */
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --warning: #ca8a04;
            --danger: #dc2626;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8fafc;
        }
        
        /* Transitions & Interact */
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }
        
        /* Checkbox & Forms */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        /* Accordion Logic */
        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .accordion-content.active {
            opacity: 1;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="max-w-6xl mx-auto p-4 min-h-screen flex flex-col">
        
        <!-- HEADER -->
        <header class="flex justify-between items-center mb-8 py-4 border-b border-slate-200">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-900" id="headerTitle">Passeport de Conformité</h1>
                    <p class="text-sm text-slate-500" id="headerSubtitle">Standard International & Itinérance</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleLang()" class="flex items-center gap-2 px-3 py-1.5 rounded-full border border-slate-300 hover:bg-slate-100 transition-colors font-medium text-sm">
                    <span id="langLabel">EN</span>
                </button>
                <button onclick="resetData()" class="text-slate-400 hover:text-red-500 transition-colors" title="Reset all data">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                </button>
            </div>
        </header>

        <!-- VIEW 1: FILTERS -->
        <div id="filterView" class="flex-1 flex flex-col justify-center items-center animate-fade-in">
            <div class="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full border border-slate-100">
                
                <!-- NEW INTRODUCTORY SECTION -->
                <div class="mb-8 text-center">
                    <h2 class="text-2xl font-bold mb-2 text-slate-800" data-i18n="filterTitle">Paramétrage du projet</h2>
                    <p class="text-slate-500 mb-6" data-i18n="filterSubtitle">Standard international (Hors spécificités France)</p>
                    
                    <div class="bg-blue-50 text-blue-900 p-5 rounded-xl text-sm text-left leading-relaxed border border-blue-100 shadow-sm">
                        <div class="flex gap-3">
                            <svg class="w-6 h-6 flex-shrink-0 text-blue-600 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <p data-i18n="intro_text">
                                Anticiper les aspects légaux et réglementaires est une étape clé pour garantir la pérennité de votre projet et la sécurité de tous. Une conformité bien préparée dès la phase de planification évite les risques et les oublis majeurs. Cet outil vous aide à identifier instantanément les démarches indispensables en fonction du profil de votre projet, vous offrant ainsi une feuille de route claire pour une mise en œuvre sereine.
                            </p>
                        </div>
                    </div>
                </div>

                <form id="filterForm" onsubmit="submitFilters(event)" class="space-y-6">
                    
                    <!-- Full List Toggle -->
                    <div class="flex justify-end mb-4">
                        <label class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="f_show_all" class="sr-only toggle-checkbox">
                                <div class="w-10 h-6 bg-gray-200 rounded-full shadow-inner toggle-label transition-colors"></div>
                                <div class="dot absolute w-4 h-4 bg-white rounded-full shadow left-1 top-1 transition-transform"></div>
                            </div>
                            <div class="ml-3 text-sm font-bold text-slate-600" data-i18n="q_show_all">Voir TOUT (Mode Expert)</div>
                        </label>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-slate-700" data-i18n="q_audience">Type de public</label>
                            <select id="f_audience" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="minors">Mineurs (-18)</option>
                                <option value="adults">Majeurs uniquement</option>
                                <option value="mixed">Mixte / Familles</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-slate-700" data-i18n="q_nights">Type d'accueil</label>
                            <select id="f_nights" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="yes">Avec hébergement (Séjour)</option>
                                <option value="no">Journée (Sans hébergement)</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700" data-i18n="q_location">Lieu du projet</label>
                        <div class="flex gap-2">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="location" value="local" class="peer sr-only" checked>
                                <div class="p-3 text-center border rounded-lg peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-700 hover:bg-slate-50" data-i18n="loc_local">Local (Sur place)</div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="location" value="national" class="peer sr-only">
                                <div class="p-3 text-center border rounded-lg peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-700 hover:bg-slate-50" data-i18n="loc_national">National (Déplacement)</div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="location" value="abroad" class="peer sr-only">
                                <div class="p-3 text-center border rounded-lg peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-700 hover:bg-slate-50" data-i18n="loc_abroad">International (Étranger)</div>
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-slate-50">
                            <input type="checkbox" id="f_transport" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-slate-700 font-medium" data-i18n="q_transport">Organisation du transport ?</span>
                        </label>
                        <label class="flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-slate-50">
                            <input type="checkbox" id="f_food" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-slate-700 font-medium" data-i18n="q_food">Restauration (Cuisine sur place) ?</span>
                        </label>
                    </div>

                    <!-- Special Modules -->
                    <div class="border-t border-slate-100 pt-4 space-y-3">
                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wide">Modules Spécifiques</h3>
                        
                        <label class="flex items-center space-x-3 p-3 border border-orange-200 bg-orange-50 rounded-lg cursor-pointer hover:bg-orange-100">
                            <input type="checkbox" id="f_roaming" class="w-5 h-5 text-orange-600 rounded focus:ring-orange-500">
                            <div class="flex flex-col">
                                <span class="text-slate-800 font-bold" data-i18n="q_roaming">Projet Itinérant / Road Trip ?</span>
                                <span class="text-xs text-slate-500" data-i18n="q_roaming_desc">Changement d'hébergement fréquent, déplacements quotidiens.</span>
                            </div>
                        </label>

                         <label class="flex items-center space-x-3 p-3 border border-yellow-200 bg-yellow-50 rounded-lg cursor-pointer hover:bg-yellow-100">
                            <input type="checkbox" id="f_event" class="w-5 h-5 text-yellow-600 rounded focus:ring-yellow-500">
                            <div class="flex flex-col">
                                <span class="text-slate-800 font-bold" data-i18n="q_event">Événement Public / Festival ?</span>
                                <span class="text-xs text-slate-500" data-i18n="q_event_desc">Pour concerts, fêtes, manifestations publiques...</span>
                            </div>
                        </label>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition-all flex justify-center items-center gap-2">
                        <span data-i18n="btn_generate">Générer le Passeport</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- VIEW 2: DASHBOARD -->
        <div id="dashboardView" class="hidden flex-col gap-6 animate-fade-in pb-10">
            
            <!-- Progress -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800" data-i18n="progress_title">Progression</h2>
                        <p class="text-sm text-slate-500"><span id="completedCount">0</span>/<span id="totalCount">0</span> actions validées</p>
                    </div>
                    <div class="text-2xl font-bold text-blue-600" id="percentDisplay">0%</div>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                    <div id="progressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
                </div>
            </div>

            <!-- Cards Container -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="cardsContainer">
                <!-- Cards injected by JS -->
            </div>

            <!-- Actions Footer -->
            <div class="flex flex-wrap justify-between items-center gap-4 mt-4 pt-6 border-t border-slate-200 global-actions">
                <button onclick="backToFilters()" class="text-slate-500 hover:text-slate-800 font-medium text-sm flex items-center gap-2">
                    ← Modifier les paramètres
                </button>
                <div class="flex gap-3">
                    <button onclick="exportCSV()" class="text-slate-600 hover:text-slate-900 border border-slate-300 hover:border-slate-400 px-4 py-2.5 rounded-lg shadow-sm transition-colors text-sm font-medium">
                        Export CSV
                    </button>
                    <!-- NEW PDF METHOD BUTTON -->
                    <button onclick="generatePrintView()" class="bg-slate-800 hover:bg-slate-900 text-white px-5 py-2.5 rounded-lg shadow transition-colors flex items-center gap-2 font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>
                        <span data-i18n="btn_pdf">Générer PDF (Nouvelle Fenêtre)</span>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal Template -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto shadow-2xl relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800">✕</button>
            <div id="modalContent" class="p-6"></div>
        </div>
    </div>

    <script>
        // --- TRANSLATIONS & CONFIG ---
        const dictionary = {
            fr: {
                filterTitle: "Paramétrage du projet",
                filterSubtitle: "Standard international (Hors spécificités France)",
                intro_text: "Anticiper les aspects légaux et réglementaires est une étape clé pour garantir la pérennité de votre projet et la sécurité de tous. Une conformité bien préparée dès la phase de planification évite les risques et les oublis majeurs. Cet outil vous aide à identifier instantanément les démarches indispensables en fonction du profil de votre projet, vous offrant ainsi une feuille de route claire pour une mise en œuvre sereine.",
                q_audience: "Type de public",
                q_nights: "Type d'accueil",
                q_location: "Lieu du projet",
                loc_local: "Local (Sur place)",
                loc_national: "National (Déplacement)",
                loc_abroad: "International (Étranger)",
                q_transport: "Organisation du transport ?",
                q_food: "Restauration (Cuisine sur place) ?",
                q_event: "Événement Public / Festival ?",
                q_event_desc: "Pour concerts, fêtes, manifestations publiques...",
                q_roaming: "Projet Itinérant / Road Trip ?",
                q_roaming_desc: "Changement d'hébergement fréquent, déplacements quotidiens.",
                q_show_all: "Voir TOUT (Liste Complète)",
                btn_generate: "Générer le Passeport",
                progress_title: "Progression de conformité",
                btn_pdf: "Générer PDF (Nouvelle Fenêtre)",
                card_1_title: "Cadre & Organisation",
                card_2_title: "Sécurité & Urgences",
                card_3_title: "Administratif & Légal",
                card_4_title: "Équipe & Participants",
                card_5_title: "Logistique & Voyage",
                card_6_title: "Événementiel & Public",
                card_7_title: "Itinérance & Logistique Mobile"
            },
            en: {
                filterTitle: "Project Setup",
                filterSubtitle: "International Standard (Non-country specific)",
                intro_text: "Anticipating legal and regulatory aspects is a key step to ensure the sustainability of your project and the safety of everyone. Well-prepared compliance from the planning phase avoids major risks and oversights. This tool helps you instantly identify essential procedures based on your project's profile, providing a clear roadmap for smooth implementation.",
                q_audience: "Audience Type",
                q_nights: "Accommodation",
                q_location: "Location",
                loc_local: "Local (On site)",
                loc_national: "National (Travel)",
                loc_abroad: "International (Abroad)",
                q_transport: "Transport organization?",
                q_food: "On-site catering (Kitchen)?",
                q_event: "Public Event / Festival?",
                q_event_desc: "For concerts, parties, public gatherings...",
                q_roaming: "Itinerant / Road Trip?",
                q_roaming_desc: "Frequent accommodation changes, daily travel.",
                q_show_all: "Show EVERYTHING (Full List)",
                btn_generate: "Generate Passport",
                progress_title: "Compliance Progress",
                btn_pdf: "Generate PDF (New Window)",
                card_1_title: "Framework & Organization",
                card_2_title: "Safety & Emergencies",
                card_3_title: "Admin & Legal",
                card_4_title: "Team & Participants",
                card_5_title: "Logistics & Travel",
                card_6_title: "Event & Public Space",
                card_7_title: "Roaming & Mobile Logistics"
            }
        };

        // --- INTERNATIONAL DATABASE ---
        const database = [
            // CATEGORIE 1 : CADRE
            {
                categoryId: 1,
                items: [
                    {
                        id: 'c1_project_edu',
                        fr: "Projet Éducatif / Mission",
                        en: "Educational Project / Mission",
                        condition: () => true,
                        details_fr: "Document définissant les objectifs pédagogiques et les valeurs de l'organisation.",
                        proof_fr: "Copie du projet signée par la direction."
                    },
                    {
                        id: 'c1_rules',
                        fr: "Code de conduite / Règlement",
                        en: "Code of Conduct / Rules",
                        condition: () => true,
                        details_fr: "Règles de vie (comportement, substances, horaires) acceptées par les participants.",
                        proof_fr: "Document signé par participants/parents."
                    },
                    {
                        id: 'c1_schedule',
                        fr: "Programme d'activités détaillé",
                        en: "Detailed Schedule",
                        condition: () => true,
                        details_fr: "Planning jour par jour incluant temps calmes, repas et activités.",
                        proof_fr: "Planning affiché et validé."
                    },
                    {
                        id: 'c1_risk_assessment',
                        fr: "Analyse des Risques (Risk Assessment)",
                        en: "Risk Assessment",
                        condition: () => true,
                        details_fr: "Matrice d'identification des risques (lieux, activités) et mesures préventives.",
                        proof_fr: "Document écrit d'évaluation des risques."
                    }
                ]
            },

            // CATEGORIE 2 : SECURITE & URGENCES
            {
                categoryId: 2,
                items: [
                    {
                        id: 'c2_emergency_list',
                        fr: "Liste Contacts d'Urgence",
                        en: "Emergency Contacts List",
                        condition: () => true,
                        details_fr: "Liste imprimée: Police locale, Pompiers, Urgences médicales, Ambassade (si étranger), Siège social.",
                        proof_fr: "Affichée et dans les téléphones des responsables."
                    },
                    {
                        id: 'c2_action_plan',
                        fr: "Plan d'Action d'Urgence",
                        en: "Emergency Action Plan",
                        condition: () => true,
                        details_fr: "Procédure écrite en cas d'accident, disparition ou évacuation.",
                        proof_fr: "Document de procédure connu de l'équipe."
                    },
                    {
                        id: 'c2_first_aid',
                        fr: "Kits de Premiers Secours",
                        en: "First Aid Kits",
                        condition: () => true,
                        details_fr: "Vérifier le contenu et les dates de péremption. Un kit principal + kits mobiles.",
                        proof_fr: "Checklist matériel signée."
                    },
                    {
                        id: 'c2_food_safety',
                        fr: "Sécurité Alimentaire / Hygiène",
                        en: "Food Safety / Hygiene",
                        condition: (f) => f.food === true,
                        details_fr: "Protocoles d'hygiène cuisine, traçabilité des aliments, régimes spéciaux et allergies.",
                        proof_fr: "Relevés de températures et liste allergènes."
                    },
                    {
                        id: 'c2_fire_safety',
                        fr: "Sécurité Incendie",
                        en: "Fire Safety",
                        condition: (f) => f.nights === 'yes' || f.event === true,
                        details_fr: "Vérification extincteurs, détecteurs fumée et issues de secours.",
                        proof_fr: "Registre de sécurité du bâtiment."
                    }
                ]
            },

            // CATEGORIE 3 : ADMIN & LEGAL
            {
                categoryId: 3,
                items: [
                    {
                        id: 'c3_auth_declaration',
                        fr: "Déclaration aux Autorités",
                        en: "Local Authority Declaration",
                        condition: (f) => f.audience === 'minors',
                        details_fr: "Enregistrement du séjour auprès des autorités compétentes locales ou nationales.",
                        proof_fr: "Preuve de dépôt ou récépissé d'autorisation."
                    },
                    {
                        id: 'c3_insurance',
                        fr: "Assurance Responsabilité Civile",
                        en: "Liability Insurance",
                        condition: () => true,
                        details_fr: "Couverture complète pour l'organisation, le personnel et les participants.",
                        proof_fr: "Certificat d'assurance valide pour la période et le lieu."
                    },
                    {
                        id: 'c3_incident_report',
                        fr: "Registre d'Incidents",
                        en: "Incident Report Register",
                        condition: () => true,
                        details_fr: "Cahier ou fichier pour consigner tout accident ou incident mineur/majeur.",
                        proof_fr: "Registre vierge disponible."
                    },
                    {
                        id: 'c3_budget',
                        fr: "Suivi Budgétaire & Factures",
                        en: "Budget & Invoices",
                        condition: () => true,
                        details_fr: "Système de suivi des dépenses et conservation des factures.",
                        proof_fr: "Tableur budget ou logiciel comptable."
                    }
                ]
            },

            // CATEGORIE 4 : EQUIPE & PARTICIPANTS
            {
                categoryId: 4,
                items: [
                    {
                        id: 'c4_director_qual',
                        fr: "Directeur Certifié",
                        en: "Certified Director",
                        condition: (f) => f.audience === 'minors',
                        details_fr: "Personne en charge possédant les certifications requises pour la direction de structure.",
                        proof_fr: "Copie des diplômes/certifications."
                    },
                    {
                        id: 'c4_staff_qual',
                        fr: "Encadrants Qualifiés",
                        en: "Qualified Staff",
                        condition: (f) => f.audience === 'minors',
                        details_fr: "Ratio d'encadrement respecté. Personnel formé à l'animation et sécurité.",
                        proof_fr: "Liste du personnel avec qualifications."
                    },
                    {
                        id: 'c4_specialist',
                        fr: "Qualif. Activités Spécifiques",
                        en: "Activity Specialists",
                        condition: () => true,
                        details_fr: "Pour activités à risque (natation, escalade, etc.) : personnel disposant des brevets d'état/certifications spécifiques.",
                        proof_fr: "Copies des brevets/licences des intervenants."
                    },
                    {
                        id: 'c4_background_check',
                        fr: "Vérification Casier Judiciaire",
                        en: "Criminal Record Check",
                        condition: (f) => f.audience === 'minors',
                        details_fr: "Vérification de l'absence de condamnations incompatibles avec la jeunesse.",
                        proof_fr: "Extrait de casier judiciaire récent."
                    },
                    {
                        id: 'c4_health_form',
                        fr: "Fiche Santé Participant",
                        en: "Participant Health Form",
                        condition: () => true,
                        details_fr: "Fiche individuelle pour CHAQUE participant (Antécédents, Allergies, Traitements, Contact urgence).",
                        proof_fr: "Dossier confidentiel complet sur place."
                    }
                ]
            },

            // CATEGORIE 5 : LOGISTIQUE & VOYAGE
            {
                categoryId: 5,
                items: [
                    {
                        id: 'c5_venue_safety',
                        fr: "Conformité Hébergement",
                        en: "Accommodation Safety",
                        condition: (f) => f.nights === 'yes',
                        details_fr: "Bâtiments aux normes incendie/sécurité locales. Issues de secours dégagées.",
                        proof_fr: "Certificat de sécurité ou audit des lieux."
                    },
                    {
                        id: 'c5_travel_insurance',
                        fr: "Assurance Voyage & Rapatriement",
                        en: "Travel & Repatriation Insurance",
                        condition: (f) => f.location === 'abroad' || f.location === 'national',
                        details_fr: "Assurance couvrant frais médicaux à l'étranger et rapatriement sanitaire.",
                        proof_fr: "Numéro de police d'assistance 24/7."
                    },
                    {
                        id: 'c5_passports',
                        fr: "Passeports & Visas",
                        en: "Passports & Visas",
                        condition: (f) => f.location === 'abroad',
                        details_fr: "Vérifier validité passeports (+6 mois après retour) et obtention des visas nécessaires.",
                        proof_fr: "Scan des passeports (sécurisé) ou checklist validée."
                    },
                    {
                        id: 'c5_travel_auth',
                        fr: "Autorisation de Voyage (Mineurs)",
                        en: "Minor Travel Authorization",
                        condition: (f) => f.location === 'abroad' && f.audience === 'minors',
                        details_fr: "Autorisation de sortie du territoire signée par les parents/tuteurs légaux.",
                        proof_fr: "Original du document pour chaque mineur."
                    },
                    {
                        id: 'c5_embassy',
                        fr: "Inscription Consulaire/Ambassade",
                        en: "Embassy Registration",
                        condition: (f) => f.location === 'abroad',
                        details_fr: "Signalement du groupe à l'ambassade ou au consulat du pays d'origine.",
                        proof_fr: "Confirmation d'enregistrement."
                    },
                    {
                        id: 'c5_transport_safe',
                        fr: "Sécurité Transport",
                        en: "Transport Safety",
                        condition: (f) => f.transport === true,
                        details_fr: "Assurance véhicules, permis valides des chauffeurs, temps de repos respectés.",
                        proof_fr: "Dossier transporteur complet."
                    }
                ]
            },

            // CATEGORIE 6 : EVENEMENTIEL
            {
                categoryId: 6,
                items: [
                    {
                        id: 'c6_public_space',
                        fr: "Occupation Domaine Public",
                        en: "Public Space Permit",
                        condition: (f) => f.event === true,
                        details_fr: "Autorisation municipale pour utiliser une rue, un parc ou une place publique.",
                        proof_fr: "Arrêté municipal ou autorisation écrite."
                    },
                    {
                        id: 'c6_music_rights',
                        fr: "Droits Musique (SACEM/Copyright)",
                        en: "Music Copyrights",
                        condition: (f) => f.event === true,
                        details_fr: "Déclaration et paiement des droits pour diffusion de musique enregistrée ou live.",
                        proof_fr: "Contrat de diffusion ou facture acquittée."
                    },
                    {
                        id: 'c6_alcohol',
                        fr: "Autorisation Débit de Boissons",
                        en: "Alcohol/Bar License",
                        condition: (f) => f.event === true,
                        details_fr: "Licence temporaire pour vendre/servir de l'alcool (si applicable).",
                        proof_fr: "Récépissé de déclaration en mairie."
                    },
                    {
                        id: 'c6_security',
                        fr: "Service de Sécurité / Sûreté",
                        en: "Security Service",
                        condition: (f) => f.event === true,
                        details_fr: "Agents de sécurité qualifiés, contrôle des accès, plan vigipirate.",
                        proof_fr: "Contrat société de sécurité."
                    },
                    {
                        id: 'c6_noise',
                        fr: "Dérogation Nuisances Sonores",
                        en: "Noise Permit",
                        condition: (f) => f.event === true,
                        details_fr: "Autorisation pour diffusion sonore tardive (après 22h).",
                        proof_fr: "Arrêté de dérogation."
                    }
                ]
            },

            // CATEGORIE 7 : ITINERANCE & LOGISTIQUE MOBILE
            {
                categoryId: 7,
                items: [
                    {
                        id: 'c7_itinerary',
                        fr: "Itinéraire Détaillé Validé",
                        en: "Validated Detailed Itinerary",
                        condition: (f) => f.roaming === true,
                        details_fr: "Feuille de route jour par jour avec kilométrage, temps de trajet et points d'arrêt.",
                        proof_fr: "Roadbook ou dossier de voyage complet."
                    },
                    {
                        id: 'c7_bookings',
                        fr: "Confirmations Hébergements",
                        en: "Accommodation Confirmations",
                        condition: (f) => f.roaming === true,
                        details_fr: "Preuve de réservation pour CHAQUE étape (Camping, Auberge, Chez l'habitant).",
                        proof_fr: "Dossier de réservations chronologique."
                    },
                    {
                        id: 'c7_fallback',
                        fr: "Plan de Repli (Météo/Panne)",
                        en: "Fallback Plan (Weather/Breakdown)",
                        condition: (f) => f.roaming === true,
                        details_fr: "Solutions alternatives identifiées en cas de route bloquée, intempéries ou panne véhicule.",
                        proof_fr: "Liste des garages/hébergements de secours sur le trajet."
                    },
                    {
                        id: 'c7_communication',
                        fr: "Protocole Communication (Zones Blanches)",
                        en: "Communication Protocol (No Signal)",
                        condition: (f) => f.roaming === true,
                        details_fr: "Points de ralliement définis et horaires de check-in avec le siège si zone sans réseau.",
                        proof_fr: "Protocole écrit communiqué aux équipes."
                    },
                    {
                        id: 'c7_luggage',
                        fr: "Logistique Bagages",
                        en: "Luggage Logistics",
                        condition: (f) => f.roaming === true,
                        details_fr: "Système de transport des bagages (Véhicule suiveur ? Portage ?) et étiquetage.",
                        proof_fr: "Liste inventaire matériel collectif."
                    }
                ]
            }
        ];

        // --- STATE & APP LOGIC ---
        let state = {
            lang: 'fr',
            filters: { audience: 'minors', nights: 'yes', location: 'local', transport: false, food: false, event: false, roaming: false, show_all: false },
            progress: {}
        };

        function init() {
            const saved = localStorage.getItem('compliancePassportState_int_v4');
            if (saved) state = { ...state, ...JSON.parse(saved) };
            
            if (Object.keys(state.progress).length > 0) showDashboard();
            else showFilters();
            
            applyLanguage();
            // Restore form
            document.getElementById('f_audience').value = state.filters.audience;
            document.getElementById('f_nights').value = state.filters.nights;
            document.querySelector(`input[name="location"][value="${state.filters.location}"]`).checked = true;
            document.getElementById('f_transport').checked = state.filters.transport;
            document.getElementById('f_food').checked = state.filters.food;
            document.getElementById('f_event').checked = state.filters.event || false;
            document.getElementById('f_roaming').checked = state.filters.roaming || false;
            document.getElementById('f_show_all').checked = state.filters.show_all || false;
        }

        function saveState() {
            localStorage.setItem('compliancePassportState_int_v4', JSON.stringify(state));
            updateProgressUI();
        }

        function resetData() {
            if(confirm(state.lang === 'fr' ? "Effacer toutes les données ?" : "Reset all data?")) {
                localStorage.removeItem('compliancePassportState_int_v4');
                location.reload();
            }
        }

        function submitFilters(e) {
            e.preventDefault();
            state.filters.audience = document.getElementById('f_audience').value;
            state.filters.nights = document.getElementById('f_nights').value;
            state.filters.location = document.querySelector('input[name="location"]:checked').value;
            state.filters.transport = document.getElementById('f_transport').checked;
            state.filters.food = document.getElementById('f_food').checked;
            state.filters.event = document.getElementById('f_event').checked;
            state.filters.roaming = document.getElementById('f_roaming').checked;
            state.filters.show_all = document.getElementById('f_show_all').checked;
            
            // Init new items
            const active = getActiveItems();
            active.forEach(item => {
                if (state.progress[item.id] === undefined) state.progress[item.id] = 0;
            });
            
            saveState();
            showDashboard();
        }

        function getActiveItems() {
            if (state.filters.show_all) {
                let all = [];
                database.forEach(cat => {
                    cat.items.forEach(item => {
                        all.push({ ...item, categoryId: cat.categoryId });
                    });
                });
                return all;
            }

            let active = [];
            database.forEach(cat => {
                cat.items.forEach(item => {
                    if (item.condition(state.filters)) active.push({ ...item, categoryId: cat.categoryId });
                });
            });
            return active;
        }

        // --- RENDER ---
        function showFilters() {
            document.getElementById('filterView').classList.remove('hidden');
            document.getElementById('dashboardView').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('filterView').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');
            document.getElementById('dashboardView').classList.add('flex');
            renderCards();
            updateProgressUI();
        }

        function backToFilters() { showFilters(); }

        function renderCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            const active = getActiveItems();

            for (let i = 1; i <= 7; i++) { // Loop up to 7 categories
                const catItems = active.filter(item => item.categoryId === i);
                if (catItems.length === 0) continue;

                const total = catItems.length;
                const done = catItems.filter(item => state.progress[item.id] === 2).length;
                const wip = catItems.filter(item => state.progress[item.id] === 1).length;
                
                let statusIcon = '<span class="text-slate-300">⚠️</span>';
                let statusClass = 'border-slate-200';
                if (done === total) { statusIcon = '✅'; statusClass = 'border-green-200 bg-green-50'; }
                else if (wip > 0 || done > 0) { statusIcon = '⏳'; statusClass = 'border-yellow-200'; }

                const title = dictionary[state.lang][`card_${i}_title`];

                container.innerHTML += `
                    <div class="bg-white rounded-xl shadow-sm border ${statusClass} overflow-hidden card-hover group">
                        <div class="p-4 cursor-pointer" onclick="toggleAccordion('cat_${i}')">
                            <div class="flex justify-between items-center mb-2">
                                <div class="text-xs font-bold text-slate-400 uppercase">Module 0${i}</div>
                                <div class="card-header-icon">${statusIcon}</div>
                            </div>
                            <h3 class="font-bold text-lg text-slate-800 mb-2">${title}</h3>
                            <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                <div class="bg-blue-600 h-1.5" style="width: ${(done/total)*100}%"></div>
                            </div>
                            <div class="text-xs text-slate-400 mt-1 text-right">${done}/${total}</div>
                        </div>
                        <div id="cat_${i}" class="accordion-content bg-white border-t border-slate-100 p-4 space-y-3">
                            ${catItems.map(item => renderRow(item)).join('')}
                        </div>
                    </div>
                `;
            }
        }

        function renderRow(item) {
            const status = state.progress[item.id] || 0;
            const text = state.lang === 'fr' ? item.fr : item.en;
            
            let btnClass = "text-slate-300 bg-slate-50";
            if (status === 1) btnClass = "text-yellow-600 bg-yellow-50";
            if (status === 2) btnClass = "text-green-600 bg-green-50";

            return `
                <div class="item-row">
                    <div class="flex items-start gap-3">
                        <button onclick="cycleStatus('${item.id}')" class="mt-0.5 w-6 h-6 rounded-full flex items-center justify-center transition-colors ${btnClass}">
                            ${status === 2 ? '✓' : (status === 1 ? '•' : '')}
                        </button>
                        <div class="flex-1">
                            <div class="text-sm font-medium ${status === 2 ? 'text-slate-500 line-through' : 'text-slate-800'}">${text}</div>
                            <div class="flex gap-2 mt-1">
                                <button onclick="openDetails('${item.id}')" class="text-xs text-blue-500 hover:underline">
                                    ${state.lang === 'fr' ? 'Détails' : 'Details'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleAccordion(id) {
            const el = document.getElementById(id);
            if (el.classList.contains('active')) {
                el.style.maxHeight = '0';
                el.classList.remove('active');
            } else {
                el.classList.add('active');
                el.style.maxHeight = el.scrollHeight + "px";
            }
        }

        function cycleStatus(id) {
            state.progress[id] = ((state.progress[id] || 0) + 1) % 3;
            saveState();
            renderCards();
        }

        function updateProgressUI() {
            const active = getActiveItems();
            const done = active.filter(i => state.progress[i.id] === 2).length;
            const percent = active.length ? Math.round((done / active.length) * 100) : 0;
            document.getElementById('percentDisplay').innerText = percent + "%";
            document.getElementById('progressBar').style.width = percent + "%";
            document.getElementById('completedCount').innerText = done;
            document.getElementById('totalCount').innerText = active.length;
        }

        function openDetails(id) {
            const item = getActiveItems().find(i => i.id === id);
            if(!item) return;

            const title = state.lang === 'fr' ? item.fr : item.en;
            const details = state.lang === 'fr' ? item.details_fr : (item.details_en || item.details_fr);
            const proof = state.lang === 'fr' ? item.proof_fr : (item.proof_en || item.proof_fr);

            const html = `
                <h3 class="text-xl font-bold mb-4 text-blue-600">${title}</h3>
                <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 mb-4">
                    <h4 class="font-bold text-sm text-blue-800 mb-1">${state.lang === 'fr' ? 'À FAIRE' : 'TO DO'}</h4>
                    <p class="text-sm">${details}</p>
                </div>
                ${proof ? `<div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <h4 class="font-bold text-sm text-slate-800 mb-1">${state.lang === 'fr' ? 'PREUVE À CONSERVER' : 'PROOF TO KEEP'}</h4>
                    <p class="text-sm text-slate-600">${proof}</p>
                </div>` : ''}
            `;
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modalOverlay').classList.add('hidden'); }
        
        function toggleLang() {
            state.lang = state.lang === 'fr' ? 'en' : 'fr';
            applyLanguage();
            if(!document.getElementById('dashboardView').classList.contains('hidden')) {
                renderCards();
            }
            saveState();
        }

        function applyLanguage() {
            const texts = dictionary[state.lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (texts[key]) el.innerText = texts[key];
            });
            document.getElementById('langLabel').innerText = state.lang === 'fr' ? 'EN' : 'FR';
            document.getElementById('headerTitle').innerText = state.lang === 'fr' ? "Passeport de Conformité" : "Compliance Passport";
            document.getElementById('headerSubtitle').innerText = state.lang === 'fr' ? "Standard International & Itinérance" : "International & Roaming Standard";
        }

        function exportCSV() {
            const activeItems = getActiveItems();
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Module,Item,Status,Details,Proof\n";
            activeItems.forEach(item => {
                const catName = dictionary[state.lang][`card_${item.categoryId}_title`];
                const itemName = state.lang === 'fr' ? item.fr : item.en;
                let status = "To Do";
                if (state.progress[item.id] === 1) status = "In Progress";
                if (state.progress[item.id] === 2) status = "Done";
                const safe = (str) => `"${(str || '').replace(/"/g, '""')}"`;
                const row = [safe(catName), safe(itemName), safe(status), safe(state.lang === 'fr' ? item.details_fr : item.details_en), safe(state.lang === 'fr' ? item.proof_fr : item.proof_en)].join(",");
                csvContent += row + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "compliance_passport_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- NEW PDF GENERATION LOGIC ---
        function generatePrintView() {
            // This function creates a clean HTML string and opens it in a new window to print.
            // This bypasses iframe restrictions and CSS conflicts.
            
            const activeItems = getActiveItems();
            const date = new Date().toLocaleDateString(state.lang === 'fr' ? 'fr-FR' : 'en-US');
            const title = state.lang === 'fr' ? "Passeport de Conformité" : "Compliance Passport";
            const subtitle = state.lang === 'fr' ? "Rapport de conformité - Checklist" : "Compliance Report - Checklist";
            
            let content = `
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: sans-serif; padding: 40px; color: #333; max-width: 800px; margin: 0 auto; }
                        h1 { color: #2563eb; border-bottom: 2px solid #2563eb; padding-bottom: 10px; }
                        h2 { margin-top: 30px; font-size: 16px; text-transform: uppercase; color: #666; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                        .item { margin-bottom: 15px; page-break-inside: avoid; }
                        .item-header { display: flex; align-items: baseline; font-weight: bold; }
                        .status-box { display: inline-block; width: 14px; height: 14px; border: 1px solid #000; margin-right: 10px; }
                        .status-checked { background-color: #000; }
                        .details { margin-left: 26px; font-size: 12px; color: #555; margin-top: 4px; }
                        .footer { margin-top: 50px; border-top: 1px solid #ccc; padding-top: 10px; font-size: 10px; text-align: center; color: #999; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <p><strong>${subtitle}</strong><br>Date: ${date}</p>
            `;

            for (let i = 1; i <= 7; i++) {
                const catItems = activeItems.filter(item => item.categoryId === i);
                if (catItems.length === 0) continue;

                const catTitle = dictionary[state.lang][`card_${i}_title`];
                content += `<h2>${catTitle}</h2>`;

                catItems.forEach(item => {
                    const status = state.progress[item.id] || 0;
                    const text = state.lang === 'fr' ? item.fr : item.en;
                    const details = state.lang === 'fr' ? item.details_fr : (item.details_en || item.details_fr);
                    const proof = state.lang === 'fr' ? item.proof_fr : (item.proof_en || item.proof_fr);
                    
                    const checkMark = status === 2 ? "X" : "&nbsp;";
                    
                    content += `
                        <div class="item">
                            <div class="item-header">
                                <span class="status-box" style="text-align:center; line-height:14px;">${checkMark}</span>
                                <span>${text}</span>
                            </div>
                            <div class="details">
                                <strong>Info:</strong> ${details}<br>
                                <strong>Proof:</strong> ${proof || '-'}
                            </div>
                        </div>
                    `;
                });
            }

            content += `
                    <div class="footer">Generated via Compliance Passport App</div>
                    <script>window.onload = function() { window.print(); }<\/script>
                </body>
                </html>
            `;

            const win = window.open('', '_blank');
            win.document.write(content);
            win.document.close();
        }

        init();
    </script>
</body>
</html>
