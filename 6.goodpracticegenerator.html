<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Bonnes Pratiques - Vi-Act</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Smooth transitions for moving items */
        .section-block { transition: all 0.2s ease-in-out; }

        /* Print Styles */
        @media print {
            @page { margin: 0; size: A4; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .preview-container { 
                box-shadow: none !important; 
                margin: 0 !important; 
                width: 100% !important; 
                max-width: 100% !important;
                min-height: 100vh;
                border: none !important;
            }
            #main-layout { display: block !important; }
            #preview-col { width: 100% !important; display: block !important; }
            #editor-col { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen">

    <!-- Header -->
    <header class="bg-indigo-900 text-white p-4 shadow-md no-print sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-orange-500 p-2 rounded-lg">
                    <i data-lucide="book-open" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold leading-tight" id="header-title">Générateur de Bonnes Pratiques</h1>
                    <p class="text-xs text-indigo-200" id="header-subtitle">Capitalisation pour le Travail Jeunesse - Projet Vi-Act</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="toggleLang()" class="flex items-center gap-2 px-3 py-1 bg-indigo-800 hover:bg-indigo-700 rounded-full text-sm transition-colors border border-indigo-600">
                    <i data-lucide="globe" class="w-4 h-4"></i>
                    <span id="lang-btn-text">English</span>
                </button>
                <button onclick="window.print()" class="flex items-center gap-2 px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-bold shadow-sm transition-colors">
                    <i data-lucide="printer" class="w-4 h-4"></i>
                    <span class="hidden md:inline" id="download-btn">Télécharger / Imprimer</span>
                    <span class="md:hidden">PDF</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4 md:p-8 flex flex-col lg:flex-row gap-8" id="main-layout">

        <!-- Mobile Tabs -->
        <div class="lg:hidden flex gap-2 mb-4 no-print w-full">
            <button onclick="switchTab('edit')" id="tab-edit" class="flex-1 py-2 px-4 rounded-lg font-medium flex items-center justify-center gap-2 bg-indigo-600 text-white">
                <i data-lucide="pen-tool" class="w-4 h-4"></i> <span id="tab-edit-text">Éditeur</span>
            </button>
            <button onclick="switchTab('preview')" id="tab-preview" class="flex-1 py-2 px-4 rounded-lg font-medium flex items-center justify-center gap-2 bg-white text-slate-600">
                <i data-lucide="layout" class="w-4 h-4"></i> <span id="tab-preview-text">Aperçu</span>
            </button>
        </div>

        <!-- Editor Column -->
        <div id="editor-col" class="lg:w-1/2 flex flex-col gap-6 no-print">
            
            <!-- Info Section (Fixed Metadata) -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-lg font-bold text-indigo-900 mb-4 border-b pb-2 flex items-center gap-2">
                    <i data-lucide="user" class="text-orange-500 w-5 h-5"></i> <span id="section-info">Informations</span>
                </h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 mb-1" id="label-title">Titre</label>
                    <input type="text" id="input-title" placeholder="Ex: Atelier..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>

                <!-- Logo Upload -->
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 mb-1" id="label-logo">Logo de votre structure</label>
                    <div class="flex items-center gap-3">
                        <label class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg cursor-pointer border border-slate-300 transition-colors">
                            <i data-lucide="image" class="w-4 h-4"></i>
                            <span class="text-sm">Choisir un fichier...</span>
                            <input type="file" id="input-logo" accept="image/*" class="hidden" onchange="handleLogoUpload(this)">
                        </label>
                        <span id="logo-filename" class="text-xs text-slate-400 italic">Aucun fichier</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-slate-700 mb-1" id="label-author">Auteur</label>
                        <input type="text" id="input-author" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-slate-700 mb-1" id="label-date">Date</label>
                        <input type="date" id="input-date" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-slate-700 mb-1" id="label-type">Type</label>
                        <select id="input-type" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white">
                            <!-- Options filled by JS -->
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-slate-700 mb-1" id="label-lang-resource">Langue Ressource</label>
                        <input type="text" id="input-resource-lang" value="FR" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>

                <div class="mb-2">
                    <label class="block text-sm font-bold text-slate-700 mb-1" id="label-location">Lieu</label>
                    <input type="text" id="input-location" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>

            <!-- DYNAMIC SECTIONS CONTAINER -->
            <div id="dynamic-sections-container" class="flex flex-col gap-6">
                <!-- Sections will be injected here by JS -->
            </div>

            <!-- Add Section Button -->
            <button onclick="addNewSection()" class="w-full py-4 border-2 border-dashed border-indigo-300 rounded-xl text-indigo-500 hover:bg-indigo-50 hover:border-indigo-400 font-semibold transition-all flex items-center justify-center gap-2">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                <span id="btn-add-section">Ajouter une nouvelle section</span>
            </button>

        </div>

        <!-- Preview Column -->
        <div id="preview-col" class="hidden lg:block lg:w-1/2">
            <div class="sticky top-6">
                
                <!-- The A4 Sheet Simulation -->
                <div id="printable-area" class="preview-container bg-white w-full mx-auto shadow-2xl overflow-hidden relative flex flex-col" style="aspect-ratio: 210/297;">
                    
                    <!-- Decorative Header Bar -->
                    <div class="h-4 w-full bg-gradient-to-r from-indigo-900 via-indigo-700 to-orange-500 shrink-0"></div>

                    <div class="p-8 md:p-12 h-full flex flex-col">
                        
                        <!-- Header Preview -->
                        <div class="flex justify-between items-start border-b-2 border-indigo-100 pb-6 mb-6 shrink-0">
                            <div class="w-3/4">
                                <div class="flex gap-2 mb-2">
                                    <span class="inline-block px-3 py-1 bg-indigo-100 text-indigo-800 text-xs font-bold uppercase tracking-wider rounded" id="preview-header-tag">Fiche</span>
                                    <span class="inline-block px-3 py-1 bg-orange-100 text-orange-800 text-xs font-bold uppercase tracking-wider rounded" id="preview-viact-tag">Projet Vi-Act</span>
                                </div>
                                <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 leading-tight break-words" id="preview-title">...</h1>
                                <p class="text-slate-500 mt-2 flex items-center gap-1" id="preview-location-container">
                                    <i data-lucide="globe" class="w-3 h-3"></i> <span id="preview-location"></span>
                                </p>
                            </div>
                            <div class="w-1/4 flex flex-col items-end">
                                <!-- Logo Display -->
                                <div id="preview-logo-container" class="w-20 h-20 mb-2 flex items-center justify-center">
                                     <div id="default-logo-placeholder" class="inline-flex items-center justify-center w-16 h-16 bg-orange-50 rounded-full text-orange-500">
                                        <i data-lucide="file-text" class="w-8 h-8"></i>
                                     </div>
                                     <img id="custom-logo-img" src="" class="hidden max-w-full max-h-full object-contain" alt="Logo">
                                </div>
                                <div class="text-xs text-slate-400 font-mono" id="preview-date-print"></div>
                            </div>
                        </div>

                        <!-- Content Layout -->
                        <div class="flex flex-col gap-6 flex-grow">
                            
                            <!-- Metadata Grid (Replaces Sidebar) -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-100 items-start shrink-0">
                                <div>
                                    <p class="text-xs text-slate-500 uppercase tracking-wider font-bold mb-1" id="preview-label-author">Auteur</p>
                                    <p class="text-sm font-semibold text-indigo-900 break-words leading-tight" id="preview-author">-</p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 uppercase tracking-wider font-bold mb-1" id="preview-label-type">Type</p>
                                    <p class="text-sm font-semibold text-indigo-900 leading-tight" id="preview-type">-</p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 uppercase tracking-wider font-bold mb-1" id="preview-label-lang">Langue</p>
                                    <p class="text-sm font-semibold text-indigo-900 flex items-center gap-1 leading-tight">
                                        <i data-lucide="languages" class="w-3 h-3 text-orange-500"></i>
                                        <span id="preview-resource-lang">-</span>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 uppercase tracking-wider font-bold mb-1" id="preview-label-date">Date</p>
                                    <p class="text-sm font-semibold text-indigo-900 leading-tight" id="preview-date">-</p>
                                </div>
                            </div>

                            <!-- DYNAMIC PREVIEW CONTENT -->
                            <div id="preview-dynamic-content" class="flex flex-col gap-5">
                                <!-- Content injected here -->
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="mt-8 pt-4 border-t border-slate-200 flex justify-between items-center text-xs text-slate-400 shrink-0">
                            <span id="preview-footer-project">Projet Vi-Act - Generated with Capitalization Tool</span>
                            <span>Page 1/1</span>
                        </div>

                    </div>
                    
                    <!-- Decorative Corner -->
                    <div class="absolute bottom-0 right-0 w-16 h-16 bg-orange-500 opacity-10 rounded-tl-full"></div>
                </div>

                <!-- Print Hint -->
                <div class="mt-4 text-center no-print">
                    <p class="text-sm text-slate-500 flex items-center justify-center gap-2">
                        <i data-lucide="printer" class="w-4 h-4"></i> <span id="download-hint">Conseil : "Enregistrer au format PDF"</span>
                    </p>
                    <p class="text-xs text-slate-400 mt-1" id="filename-preview">Nom du fichier : ...</p>
                </div>
            </div>
        </div>

    </main>

    <!-- JavaScript Logic -->
    <script>
        // --- Translations ---
        const TRANSLATIONS = {
            fr: {
                title: "Générateur de Bonnes Pratiques",
                subtitle: "Capitalisation pour le Travail Jeunesse - Projet Vi-Act",
                download: "Télécharger / Imprimer (PDF)",
                downloadHint: "Choisissez 'Enregistrer au format PDF'.",
                btnAdd: "Ajouter une section",
                lblLogo: "Logo de votre structure",
                
                // Static Labels
                lblTitle: "Titre de la fiche",
                lblAuthor: "Auteur / Organisation",
                lblDate: "Date",
                lblType: "Type",
                lblLang: "Langue",
                lblLoc: "Lieu",
                
                // Default Section Titles
                secContext: "Contexte & Objectifs",
                secObjectives: "Objectifs Pédagogiques",
                secMethod: "Mise en Œuvre",
                secResources: "Ressources Nécessaires",
                secResults: "Résultats & Impact",
                secTips: "Conseils et Points de Vigilance",
                secSources: "Sources & Références",

                // Helps
                helpContext: "Pourquoi avez-vous mis cela en place ? Quel était le problème initial ?",
                helpObjectives: "Que vouliez-vous accomplir ? (Ex: Développer l'autonomie...)",
                helpResources: "Matériel, temps, budget, nombre d'animateurs...",
                helpResults: "Qu'est-ce qui a fonctionné ? Quels changements observés ?",
                helpTips: "Si quelqu'un veut refaire ça, que doit-il savoir ? Pièges à éviter ?",
                helpSources: "Liens web, bibliographie, partenaires...",
                helpDefault: "Détaillez cette partie...",

                // Preview
                pHeader: "Fiche",
                pViact: "Projet Vi-Act",
            },
            en: {
                title: "Best Practice Generator",
                subtitle: "Capitalization for Youth Work - Vi-Act Project",
                download: "Download / Print (PDF)",
                downloadHint: "Select 'Save as PDF' in print dialog.",
                btnAdd: "Add New Section",
                lblLogo: "Organization Logo",

                lblTitle: "Title",
                lblAuthor: "Author / Organization",
                lblDate: "Date",
                lblType: "Type",
                lblLang: "Language",
                lblLoc: "Location",

                secContext: "Context & Needs",
                secObjectives: "Educational Objectives",
                secMethod: "Implementation",
                secResources: "Required Resources",
                secResults: "Results & Impact",
                secTips: "Tips & Pitfalls",
                secSources: "Sources & References",

                helpContext: "Why did you start this? What was the initial need?",
                helpObjectives: "What did you want to achieve?",
                helpResources: "Materials, time, budget, staff...",
                helpResults: "What worked well? What changes did you observe?",
                helpTips: "If someone wants to replicate this, what should they know?",
                helpSources: "Web links, bibliography, partners...",
                helpDefault: "Describe this section...",

                pHeader: "Sheet",
                pViact: "Vi-Act Project",
            }
        };

        const RESOURCE_TYPES = {
            fr: ["Activité / Atelier", "Méthodologie", "Outil Pédagogique", "Événement", "Gestion de Projet", "Autre"],
            en: ["Activity / Workshop", "Methodology", "Pedagogical Tool", "Event", "Project Management", "Other"]
        };

        // --- Application State ---
        let currentLang = 'fr';
        
        // Initial Sections Structure
        // 'type' determines preview styling: 'normal', 'box-orange', 'box-indigo'
        let sections = [
            { id: 'context', key: 'secContext', content: '', helpKey: 'helpContext', type: 'normal' },
            { id: 'objectives', key: 'secObjectives', content: '', helpKey: 'helpObjectives', type: 'normal' },
            { id: 'method', key: 'secMethod', content: '', helpKey: 'helpDefault', type: 'box-gray' }, // Special handling for dynamic labels
            { id: 'resources', key: 'secResources', content: '', helpKey: 'helpResources', type: 'box-orange' },
            { id: 'results', key: 'secResults', content: '', helpKey: 'helpResults', type: 'normal' },
            { id: 'tips', key: 'secTips', content: '', helpKey: 'helpTips', type: 'box-indigo' },
            { id: 'sources', key: 'secSources', content: '', helpKey: 'helpSources', type: 'normal' }
        ];

        // --- Init ---
        window.onload = function() {
            document.getElementById('input-date').valueAsDate = new Date();
            updateTypeOptions();
            renderSections(); // Initial render of dynamic inputs
            updateStaticLabels();
            updatePreview();
            lucide.createIcons();

            // Listeners for static inputs
            ['input-title', 'input-author', 'input-date', 'input-location', 'input-resource-lang'].forEach(id => {
                document.getElementById(id).addEventListener('input', updatePreview);
            });
            document.getElementById('input-type').addEventListener('change', () => {
                updateDynamicLabels(); // For the Method section specifically
                updatePreview();
            });
        };

        // --- Core Logic ---

        function toggleLang() {
            currentLang = currentLang === 'fr' ? 'en' : 'fr';
            document.documentElement.lang = currentLang;
            document.getElementById('lang-btn-text').textContent = currentLang === 'fr' ? 'English' : 'Français';
            
            updateTypeOptions();
            updateStaticLabels();
            
            // Re-render sections to update placeholders/helps. 
            // Note: We try to preserve custom titles if they were edited? 
            // For simplicity in this version, we re-render translating default keys.
            renderSections(); 
            updatePreview();
        }

        function updateTypeOptions() {
            const select = document.getElementById('input-type');
            const currentVal = select.value;
            select.innerHTML = '';
            RESOURCE_TYPES[currentLang].forEach(type => {
                const opt = document.createElement('option');
                opt.value = type;
                opt.textContent = type;
                select.appendChild(opt);
            });
            if (RESOURCE_TYPES[currentLang].includes(currentVal)) select.value = currentVal;
            else select.value = RESOURCE_TYPES[currentLang][0];
        }

        function updateStaticLabels() {
            const t = TRANSLATIONS[currentLang];
            document.getElementById('header-title').textContent = t.title;
            document.getElementById('header-subtitle').textContent = t.subtitle;
            document.getElementById('download-btn').textContent = t.download;
            document.getElementById('download-hint').innerHTML = `<i data-lucide="printer" class="w-4 h-4 inline"></i> ${t.downloadHint}`;
            document.getElementById('btn-add-section').textContent = t.btnAdd;
            document.getElementById('label-logo').textContent = t.lblLogo;

            document.getElementById('label-title').textContent = t.lblTitle;
            document.getElementById('label-author').textContent = t.lblAuthor;
            document.getElementById('label-date').textContent = t.lblDate;
            document.getElementById('label-type').textContent = t.lblType;
            document.getElementById('label-lang-resource').textContent = t.lblLang;
            document.getElementById('label-location').textContent = t.lblLoc;

            document.getElementById('preview-header-tag').textContent = t.pHeader;
            document.getElementById('preview-viact-tag').textContent = t.pViact;
            document.getElementById('preview-label-author').textContent = t.lblAuthor;
            document.getElementById('preview-label-type').textContent = t.lblType;
            document.getElementById('preview-label-lang').textContent = t.lblLang;
            document.getElementById('preview-label-date').textContent = t.lblDate;
            document.getElementById('preview-footer-project').textContent = `${t.pViact} - Generated with Capitalization Tool`;
        }

        // --- Dynamic Sections System ---

        function renderSections() {
            const container = document.getElementById('dynamic-sections-container');
            container.innerHTML = '';

            sections.forEach((sec, index) => {
                const t = TRANSLATIONS[currentLang];
                
                // Determine Title: use custom override OR translation key default
                let displayTitle = sec.customTitle || (sec.key ? t[sec.key] : "Nouvelle Section");
                
                // Specific override for Method based on Type (legacy feature kept)
                if (sec.id === 'method') {
                    // Logic to pull dynamic label from type is complex to mix with editable titles.
                    // Simplified: We set default, user can rename.
                }

                const helpText = sec.helpKey ? t[sec.helpKey] : t.helpDefault;

                const sectionHTML = `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 section-block group" data-index="${index}">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex-grow mr-4">
                                <input 
                                    type="text" 
                                    value="${displayTitle}" 
                                    onchange="updateSectionTitle(${index}, this.value)"
                                    class="font-bold text-lg text-indigo-900 border-b border-transparent hover:border-slate-300 focus:border-indigo-500 focus:outline-none w-full bg-transparent transition-colors placeholder-indigo-300"
                                    placeholder="Titre de la section..."
                                >
                            </div>
                            <div class="flex items-center gap-1 opacity-100 lg:opacity-50 lg:group-hover:opacity-100 transition-opacity">
                                <button onclick="moveSection(${index}, -1)" class="p-2 hover:bg-slate-100 rounded text-slate-500" title="Monter">
                                    <i data-lucide="arrow-up" class="w-4 h-4"></i>
                                </button>
                                <button onclick="moveSection(${index}, 1)" class="p-2 hover:bg-slate-100 rounded text-slate-500" title="Descendre">
                                    <i data-lucide="arrow-down" class="w-4 h-4"></i>
                                </button>
                                <button onclick="deleteSection(${index})" class="p-2 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded ml-2" title="Supprimer">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <p class="text-xs text-slate-500 mb-2 italic">${helpText}</p>
                            <textarea 
                                rows="3" 
                                class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 resize-none overflow-hidden" 
                                oninput="autoResize(this); updateSectionContent(${index}, this.value)"
                            >${sec.content}</textarea>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', sectionHTML);
            });
            
            lucide.createIcons();
            
            // Auto-resize all textareas after render
            container.querySelectorAll('textarea').forEach(ta => autoResize(ta));
        }

        // --- Actions ---

        function updateSectionContent(index, value) {
            sections[index].content = value;
            updatePreview();
        }

        function updateSectionTitle(index, value) {
            sections[index].customTitle = value;
            updatePreview();
        }

        function moveSection(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= sections.length) return;
            
            // Swap
            const temp = sections[index];
            sections[index] = sections[newIndex];
            sections[newIndex] = temp;
            
            renderSections();
            updatePreview();
        }

        function deleteSection(index) {
            if(confirm("Supprimer cette section ? (Le contenu sera perdu)")) {
                sections.splice(index, 1);
                renderSections();
                updatePreview();
            }
        }

        function addNewSection() {
            sections.push({
                id: `custom-${Date.now()}`,
                customTitle: currentLang === 'fr' ? "Nouvelle Section" : "New Section",
                content: "",
                type: "normal",
                helpKey: null
            });
            renderSections();
            // Scroll to bottom
            setTimeout(() => {
                const container = document.getElementById('dynamic-sections-container');
                container.lastElementChild.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function handleLogoUpload(input) {
            const file = input.files[0];
            const placeholder = document.getElementById('default-logo-placeholder');
            const img = document.getElementById('custom-logo-img');
            const filenameSpan = document.getElementById('logo-filename');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    filenameSpan.textContent = file.name;
                }
                reader.readAsDataURL(file);
            } else {
                img.src = '';
                img.classList.add('hidden');
                placeholder.classList.remove('hidden');
                filenameSpan.textContent = 'Aucun fichier';
            }
        }

        // --- Preview Logic ---

        function updatePreview() {
            // Static Fields
            const title = document.getElementById('input-title').value;
            const author = document.getElementById('input-author').value;
            const date = document.getElementById('input-date').value;
            const type = document.getElementById('input-type').value;
            const langRes = document.getElementById('input-resource-lang').value;
            const location = document.getElementById('input-location').value;

            document.getElementById('preview-title').textContent = title || '...';
            document.getElementById('preview-title').className = title ? "text-3xl md:text-4xl font-extrabold text-slate-900 leading-tight break-words" : "text-3xl md:text-4xl font-extrabold text-slate-300 italic leading-tight break-words";
            
            document.getElementById('preview-location').textContent = location;
            document.getElementById('preview-location-container').style.display = location ? 'flex' : 'none';
            document.getElementById('preview-date-print').textContent = new Date().toLocaleDateString();
            document.getElementById('preview-author').textContent = author || '-';
            document.getElementById('preview-type').textContent = type || '-';
            document.getElementById('preview-resource-lang').textContent = langRes || '-';
            document.getElementById('preview-date').textContent = date || '-';

            // Dynamic Sections
            const previewContainer = document.getElementById('preview-dynamic-content');
            previewContainer.innerHTML = '';

            const t = TRANSLATIONS[currentLang];

            sections.forEach(sec => {
                // HIDE EMPTY CATEGORIES RULE
                if (!sec.content || sec.content.trim() === '') return;

                let title = sec.customTitle || (sec.key ? t[sec.key] : "Section");
                let html = '';

                if (sec.type === 'box-orange') {
                    html = `
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-100">
                        <h3 class="text-sm font-bold text-orange-800 mb-2 flex items-center gap-2">
                            <i data-lucide="check-circle" class="w-4 h-4"></i> ${title}
                        </h3>
                        <p class="text-sm text-slate-700 whitespace-pre-wrap">${sec.content}</p>
                    </div>`;
                } else if (sec.type === 'box-indigo') {
                    html = `
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                        <h3 class="text-sm font-bold text-indigo-800 mb-2 flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-4 h-4"></i> ${title}
                        </h3>
                        <p class="text-sm text-slate-700 italic whitespace-pre-wrap">${sec.content}</p>
                    </div>`;
                } else if (sec.type === 'box-gray') {
                    // Method style
                    html = `
                    <section class="bg-slate-50 p-5 rounded-xl border border-slate-100">
                        <h3 class="text-lg font-bold text-indigo-900 mb-3">${title}</h3>
                        <p class="text-slate-700 leading-relaxed text-sm whitespace-pre-wrap">${sec.content}</p>
                    </section>`;
                } else {
                    // Normal style
                    html = `
                    <section>
                        <h3 class="text-lg font-bold text-indigo-900 mb-2 border-b border-indigo-100 pb-1">${title}</h3>
                        <p class="text-slate-700 leading-relaxed text-sm whitespace-pre-wrap">${sec.content}</p>
                    </section>`;
                }

                previewContainer.insertAdjacentHTML('beforeend', html);
            });

            lucide.createIcons();
            updateFilename(date, langRes, title, author);
        }

        // --- Helpers ---
        
        function updateDynamicLabels() {
            // Optional: You could update the "Method" section's default title based on Type here
            // But with the renaming feature, it's safer to leave it as "Mise en œuvre" default
        }

        function getInitials(name) {
            if (!name) return 'UNK';
            const parts = name.trim().split(/\s+/);
            if (parts.length === 1) return parts[0].substring(0, 3).toUpperCase();
            return (parts[0][0] + (parts[1] ? parts[1][0] : '')).toUpperCase();
        }

        function updateFilename(date, langRes, title, author) {
            const dateStr = date || 'NoDate';
            const cleanTitle = (title || 'Untitled')
                .replace(/[^a-zA-Z0-9à-ÿÀ-Ÿ\s-]/g, '')
                .trim()
                .replace(/\s+/g, '-')
                .substring(0, 40);
            
            const langCode = (langRes || currentLang).substring(0, 2).toUpperCase();
            const initials = getInitials(author);

            const fileName = `${dateStr}_${langCode}_${cleanTitle}_${initials}`;
            
            document.title = fileName;
            document.getElementById('filename-preview').textContent = `Fichier : ${fileName}.pdf`;
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function switchTab(tab) {
            const editCol = document.getElementById('editor-col');
            const previewCol = document.getElementById('preview-col');
            const btnEdit = document.getElementById('tab-edit');
            const btnPreview = document.getElementById('tab-preview');

            if (tab === 'edit') {
                editCol.classList.remove('hidden');
                editCol.classList.add('flex');
                previewCol.classList.add('hidden');
                btnEdit.classList.add('bg-indigo-600', 'text-white');
                btnEdit.classList.remove('bg-white', 'text-slate-600');
                btnPreview.classList.add('bg-white', 'text-slate-600');
                btnPreview.classList.remove('bg-indigo-600', 'text-white');
            } else {
                editCol.classList.add('hidden');
                editCol.classList.remove('flex');
                previewCol.classList.remove('hidden');
                previewCol.classList.add('block');
                btnPreview.classList.add('bg-indigo-600', 'text-white');
                btnPreview.classList.remove('bg-white', 'text-slate-600');
                btnEdit.classList.add('bg-white', 'text-slate-600');
                btnEdit.classList.remove('bg-indigo-600', 'text-white');
            }
        }
    </script>
</body>
</html>
