<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Bonnes Pratiques - Vi-Act</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Smooth transitions for moving items */
        .section-block { transition: all 0.2s ease-in-out; }
        
        canvas { touch-action: none; cursor: crosshair; }

        /* Print Styles */
        @media print {
            @page { margin: 0; size: A4; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .preview-container { 
                box-shadow: none !important; 
                margin: 0 !important; 
                width: 100% !important; 
                max-width: 100% !important;
                /* Allow print to flow naturally */
                height: auto !important;
                min-height: 0 !important;
                border: none !important;
            }
            #main-layout { display: block !important; }
            #preview-col { 
                width: 100% !important; 
                display: block !important; 
                height: auto !important; 
                position: static !important;
                overflow: visible !important;
            }
            #editor-col { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen">

    <!-- Header -->
    <header class="bg-indigo-900 text-white p-4 shadow-md no-print sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-orange-500 p-2 rounded-lg">
                    <i data-lucide="book-open" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold leading-tight" id="header-title">Générateur de Bonnes Pratiques</h1>
                    <p class="text-xs text-indigo-200" id="header-subtitle">Capitalisation pour le Travail Jeunesse - Projet Vi-Act</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="toggleLang()" class="flex items-center gap-2 px-3 py-1 bg-indigo-800 hover:bg-indigo-700 rounded-full text-sm transition-colors border border-indigo-600">
                    <i data-lucide="globe" class="w-4 h-4"></i>
                    <span id="lang-btn-text">English</span>
                </button>
                <button onclick="window.print()" class="flex items-center gap-2 px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-bold shadow-sm transition-colors">
                    <i data-lucide="printer" class="w-4 h-4"></i>
                    <span class="hidden md:inline" id="download-btn">Télécharger / Imprimer</span>
                    <span class="md:hidden">PDF</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4 md:p-8 flex flex-col lg:flex-row gap-8 items-start" id="main-layout">

        <!-- Mobile Tabs -->
        <div class="lg:hidden flex gap-2 mb-4 no-print w-full">
            <button onclick="switchTab('edit')" id="tab-edit" class="flex-1 py-2 px-4 rounded-lg font-medium flex items-center justify-center gap-2 bg-indigo-600 text-white">
                <i data-lucide="pen-tool" class="w-4 h-4"></i> <span id="tab-edit-text">Éditeur</span>
            </button>
            <button onclick="switchTab('preview')" id="tab-preview" class="flex-1 py-2 px-4 rounded-lg font-medium flex items-center justify-center gap-2 bg-white text-slate-600">
                <i data-lucide="layout" class="w-4 h-4"></i> <span id="tab-preview-text">Aperçu</span>
            </button>
        </div>

        <!-- Editor Column -->
        <div id="editor-col" class="lg:w-1/2 flex flex-col gap-6 no-print">
            
            <!-- Info Section (Fixed Metadata) -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-lg font-bold text-indigo-900 mb-4 border-b pb-2 flex items-center gap-2">
                    <i data-lucide="user" class="text-orange-500 w-5 h-5"></i> <span id="section-info">Informations</span>
                </h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 mb-1" id="label-title">Titre</label>
                    <input type="text" id="input-title" placeholder="Ex: Atelier..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>

                <!-- Logo Upload -->
                <div class="mb-4">
                    <label class="block text-sm font-bold text-slate-700 mb-1" id="label-logo">Logo de votre structure</label>
                    <div class="flex items-center gap-3">
                        <label class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg cursor-pointer border border-slate-300 transition-colors">
                            <i data-lucide="image" class="w-4 h-4"></i>
                            <span class="text-sm">Choisir un fichier...</span>
                            <input type="file" id="input-logo" accept="image/*" class="hidden" onchange="handleLogoUpload(this)">
                        </label>
                        <span id="logo-filename" class="text-xs text-slate-400 italic">Aucun fichier</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-slate-700 mb-1" id="label-author">Auteur</label>
                        <input type="text" id="input-author" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-slate-700 mb-1" id="label-date">Date</label>
                        <input type="date" id="input-date" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-slate-700 mb-1" id="label-type">Type</label>
                        <select id="input-type" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white">
                            <!-- Options filled by JS -->
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-slate-700 mb-1" id="label-lang-resource">Langue Ressource</label>
                        <input type="text" id="input-resource-lang" value="FR" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>

                <div class="mb-2">
                    <label class="block text-sm font-bold text-slate-700 mb-1" id="label-location">Lieu</label>
                    <input type="text" id="input-location" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>

            <!-- DYNAMIC SECTIONS CONTAINER -->
            <div id="dynamic-sections-container" class="flex flex-col gap-6">
                <!-- Sections will be injected here by JS -->
            </div>

            <!-- Add Section Buttons -->
            <div class="grid grid-cols-3 gap-2">
                <button onclick="addNewSection('text')" class="py-3 px-2 border-2 border-dashed border-indigo-300 rounded-xl text-indigo-500 hover:bg-indigo-50 hover:border-indigo-400 font-semibold transition-all flex flex-col items-center justify-center gap-1">
                    <i data-lucide="align-left" class="w-5 h-5"></i>
                    <span id="btn-add-text" class="text-xs">Texte</span>
                </button>
                <button onclick="addNewSection('image')" class="py-3 px-2 border-2 border-dashed border-orange-300 rounded-xl text-orange-500 hover:bg-orange-50 hover:border-orange-400 font-semibold transition-all flex flex-col items-center justify-center gap-1">
                    <i data-lucide="image-plus" class="w-5 h-5"></i>
                    <span id="btn-add-image" class="text-xs">Image</span>
                </button>
                 <button onclick="addNewSection('drawing')" class="py-3 px-2 border-2 border-dashed border-purple-300 rounded-xl text-purple-500 hover:bg-purple-50 hover:border-purple-400 font-semibold transition-all flex flex-col items-center justify-center gap-1">
                    <i data-lucide="pencil" class="w-5 h-5"></i>
                    <span id="btn-add-drawing" class="text-xs">Dessin</span>
                </button>
            </div>

        </div>

        <!-- Preview Column -->
        <div id="preview-col" class="hidden lg:block lg:w-1/2 sticky top-20 h-[calc(100vh-6rem)] overflow-y-auto pb-10">
            
            <!-- The A4 Sheet Simulation -->
            <!-- Changed aspect-ratio to min-height to allow growth -->
            <div id="printable-area" class="preview-container bg-white w-full mx-auto shadow-2xl relative flex flex-col" style="min-height: 297mm;">
                
                <!-- Decorative Header Bar -->
                <div class="h-4 w-full bg-gradient-to-r from-indigo-900 via-indigo-700 to-orange-500 shrink-0"></div>

                <div class="p-8 md:p-12 h-full flex flex-col">
                    
                    <!-- Header Preview -->
                    <div class="flex justify-between items-start border-b-2 border-indigo-100 pb-6 mb-6 shrink-0">
                        <div class="w-3/4">
                            <div class="flex gap-2 mb-2">
                                <span class="inline-block px-3 py-1 bg-indigo-100 text-indigo-800 text-xs font-bold uppercase tracking-wider rounded" id="preview-header-tag">Fiche</span>
                                <span class="inline-block px-3 py-1 bg-orange-100 text-orange-800 text-xs font-bold uppercase tracking-wider rounded" id="preview-viact-tag">Projet Vi-Act</span>
                            </div>
                            <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 leading-tight break-words" id="preview-title">...</h1>
                            <p class="text-slate-500 mt-2 flex items-center gap-1" id="preview-location-container">
                                <i data-lucide="globe" class="w-3 h-3"></i> <span id="preview-location"></span>
                            </p>
                        </div>
                        <div class="w-1/4 flex flex-col items-end">
                            <!-- Logo Display -->
                            <div id="preview-logo-container" class="w-20 h-20 mb-2 flex items-center justify-center">
                                    <div id="default-logo-placeholder" class="inline-flex items-center justify-center w-16 h-16 bg-orange-50 rounded-full text-orange-500">
                                    <i data-lucide="file-text" class="w-8 h-8"></i>
                                    </div>
                                    <img id="custom-logo-img" src="" class="hidden max-w-full max-h-full object-contain" alt="Logo">
                            </div>
                            <div class="text-xs text-slate-400 font-mono" id="preview-date-print"></div>
                        </div>
                    </div>

                    <!-- Content Layout -->
                    <div class="flex flex-col gap-6 flex-grow">
                        
                        <!-- Metadata Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-100 items-start shrink-0">
                            <div>
                                <p class="text-xs text-slate-500 uppercase tracking-wider font-bold mb-1" id="preview-label-author">Auteur</p>
                                <p class="text-sm font-semibold text-indigo-900 break-words leading-tight" id="preview-author">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 uppercase tracking-wider font-bold mb-1" id="preview-label-type">Type</p>
                                <p class="text-sm font-semibold text-indigo-900 leading-tight" id="preview-type">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 uppercase tracking-wider font-bold mb-1" id="preview-label-lang">Langue</p>
                                <p class="text-sm font-semibold text-indigo-900 flex items-center gap-1 leading-tight">
                                    <i data-lucide="languages" class="w-3 h-3 text-orange-500"></i>
                                    <span id="preview-resource-lang">-</span>
                                </p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 uppercase tracking-wider font-bold mb-1" id="preview-label-date">Date</p>
                                <p class="text-sm font-semibold text-indigo-900 leading-tight" id="preview-date">-</p>
                            </div>
                        </div>

                        <!-- DYNAMIC PREVIEW CONTENT -->
                        <div id="preview-dynamic-content" class="flex flex-col gap-5">
                            <!-- Content injected here -->
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="mt-8 pt-4 border-t border-slate-200 flex justify-between items-center text-xs text-slate-400 shrink-0">
                        <span id="preview-footer-project">Projet Vi-Act - Generated with Capitalization Tool</span>
                        <span>Page 1/1</span>
                    </div>

                </div>
                
                <!-- Decorative Corner -->
                <div class="absolute bottom-0 right-0 w-16 h-16 bg-orange-500 opacity-10 rounded-tl-full"></div>
            </div>

            <!-- Print Hint -->
            <div class="mt-4 text-center no-print">
                <p class="text-sm text-slate-500 flex items-center justify-center gap-2">
                    <i data-lucide="printer" class="w-4 h-4"></i> <span id="download-hint">Conseil : "Enregistrer au format PDF"</span>
                </p>
                <p class="text-xs text-slate-400 mt-1" id="filename-preview">Nom du fichier : ...</p>
            </div>
        </div>

    </main>

    <!-- JavaScript Logic -->
    <script>
        // --- Translations ---
        const TRANSLATIONS = {
            fr: {
                title: "Générateur de Bonnes Pratiques",
                subtitle: "Capitalisation pour le Travail Jeunesse - Projet Vi-Act",
                download: "Télécharger / Imprimer (PDF)",
                downloadHint: "Choisissez 'Enregistrer au format PDF'.",
                btnAddText: "Texte",
                btnAddImage: "Image",
                btnAddDrawing: "Dessin",
                lblLogo: "Logo de votre structure",
                lblCaption: "Légende",
                
                // Static Labels
                lblTitle: "Titre de la fiche",
                lblAuthor: "Auteur / Organisation",
                lblDate: "Date",
                lblType: "Type",
                lblLang: "Langue",
                lblLoc: "Lieu",
                
                // Helps
                helpContext: "Pourquoi avez-vous mis cela en place ? Quel était le problème initial ?",
                helpObjectives: "Que vouliez-vous accomplir ? (Ex: Développer l'autonomie...)",
                helpResources: "Matériel, temps, budget, nombre d'animateurs...",
                helpResults: "Qu'est-ce qui a fonctionné ? Quels changements observés ?",
                helpTips: "Si quelqu'un veut refaire ça, que doit-il savoir ? Pièges à éviter ?",
                helpSources: "Liens web, bibliographie, partenaires...",
                helpDefault: "Détaillez cette partie...",
                helpImage: "Chargez une photo (jpg, png) pour illustrer.",
                helpDrawing: "Dessinez votre schéma. Utilisez les formes pour plus de précision.",

                // Preview
                pHeader: "Fiche",
                pViact: "Projet Vi-Act",
            },
            en: {
                title: "Best Practice Generator",
                subtitle: "Capitalization for Youth Work - Vi-Act Project",
                download: "Download / Print (PDF)",
                downloadHint: "Select 'Save as PDF' in print dialog.",
                btnAddText: "Text",
                btnAddImage: "Image",
                btnAddDrawing: "Drawing",
                lblLogo: "Organization Logo",
                lblCaption: "Caption",

                lblTitle: "Title",
                lblAuthor: "Author / Organization",
                lblDate: "Date",
                lblType: "Type",
                lblLang: "Language",
                lblLoc: "Location",

                helpContext: "Why did you start this? What was the initial need?",
                helpObjectives: "What did you want to achieve?",
                helpResources: "Materials, time, budget, staff...",
                helpResults: "What worked well? What changes did you observe?",
                helpTips: "If someone wants to replicate this, what should they know?",
                helpSources: "Web links, bibliography, partners...",
                helpDefault: "Describe this section...",
                helpImage: "Upload a photo (jpg, png) to illustrate.",
                helpDrawing: "Draw your diagram. Use shapes for precision.",

                pHeader: "Sheet",
                pViact: "Vi-Act Project",
            }
        };

        const RESOURCE_TYPES = {
            fr: ["Activité / Atelier", "Méthodologie", "Outil Pédagogique", "Événement", "Gestion de Projet", "Autre"],
            en: ["Activity / Workshop", "Methodology", "Pedagogical Tool", "Event", "Project Management", "Other"]
        };

        // --- Application State ---
        let currentLang = 'fr';
        
        let sections = [
            { id: 'context', key: 'secContext', customTitle: 'Contexte & Objectifs', content: '', helpKey: 'helpContext', type: 'normal', contentType: 'text' },
            { id: 'objectives', key: 'secObjectives', customTitle: 'Objectifs Pédagogiques', content: '', helpKey: 'helpObjectives', type: 'normal', contentType: 'text' },
            { id: 'method', key: 'secMethod', customTitle: 'Mise en Œuvre', content: '', helpKey: 'helpDefault', type: 'box-gray', contentType: 'text' }, 
            { id: 'resources', key: 'secResources', customTitle: 'Ressources Nécessaires', content: '', helpKey: 'helpResources', type: 'box-orange', contentType: 'text' },
            { id: 'results', key: 'secResults', customTitle: 'Résultats & Impact', content: '', helpKey: 'helpResults', type: 'normal', contentType: 'text' },
            { id: 'tips', key: 'secTips', customTitle: 'Conseils et Points de Vigilance', content: '', helpKey: 'helpTips', type: 'box-indigo', contentType: 'text' },
            { id: 'sources', key: 'secSources', customTitle: 'Sources & Références', content: '', helpKey: 'helpSources', type: 'normal', contentType: 'text' }
        ];

        // --- Init ---
        window.onload = function() {
            document.getElementById('input-date').valueAsDate = new Date();
            updateTypeOptions();
            renderSections(); 
            updateStaticLabels();
            updatePreview();
            lucide.createIcons();

            ['input-title', 'input-author', 'input-date', 'input-location', 'input-resource-lang'].forEach(id => {
                document.getElementById(id).addEventListener('input', updatePreview);
            });
            document.getElementById('input-type').addEventListener('change', () => {
                updatePreview();
            });
            
            // Handle Window Resize to fix canvas aspect ratio
            window.addEventListener('resize', () => {
                sections.forEach((sec, index) => {
                    if (sec.contentType === 'drawing') {
                        initCanvas(index, true); // true = preserve content
                    }
                });
            });
        };

        // --- Core Logic ---

        function toggleLang() {
            currentLang = currentLang === 'fr' ? 'en' : 'fr';
            document.documentElement.lang = currentLang;
            document.getElementById('lang-btn-text').textContent = currentLang === 'fr' ? 'English' : 'Français';
            
            updateTypeOptions();
            updateStaticLabels();
            renderSections(); 
            updatePreview();
        }

        function updateTypeOptions() {
            const select = document.getElementById('input-type');
            const currentVal = select.value;
            select.innerHTML = '';
            RESOURCE_TYPES[currentLang].forEach(type => {
                const opt = document.createElement('option');
                opt.value = type;
                opt.textContent = type;
                select.appendChild(opt);
            });
            if (RESOURCE_TYPES[currentLang].includes(currentVal)) select.value = currentVal;
            else select.value = RESOURCE_TYPES[currentLang][0];
        }

        function updateStaticLabels() {
            const t = TRANSLATIONS[currentLang];
            document.getElementById('header-title').textContent = t.title;
            document.getElementById('header-subtitle').textContent = t.subtitle;
            document.getElementById('download-btn').textContent = t.download;
            
            // Text only update
            document.getElementById('download-hint').childNodes.forEach(node => {
                if(node.nodeType === 3) node.textContent = " " + t.downloadHint;
            });
            
            // Button labels update (preserving icons)
            const updateBtnLabel = (id, text) => {
                const el = document.getElementById(id);
                if(el) {
                    const span = el.querySelector('span');
                    if(span) span.textContent = text;
                }
            };
            
            updateBtnLabel('btn-add-text', t.btnAddText);
            updateBtnLabel('btn-add-image', t.btnAddImage);
            updateBtnLabel('btn-add-drawing', t.btnAddDrawing);
            
            document.getElementById('label-logo').textContent = t.lblLogo;
            document.getElementById('label-title').textContent = t.lblTitle;
            document.getElementById('label-author').textContent = t.lblAuthor;
            document.getElementById('label-date').textContent = t.lblDate;
            document.getElementById('label-type').textContent = t.lblType;
            document.getElementById('label-lang-resource').textContent = t.lblLang;
            document.getElementById('label-location').textContent = t.lblLoc;

            document.getElementById('preview-header-tag').textContent = t.pHeader;
            document.getElementById('preview-viact-tag').textContent = t.pViact;
            document.getElementById('preview-label-author').textContent = t.lblAuthor;
            document.getElementById('preview-label-type').textContent = t.lblType;
            document.getElementById('preview-label-lang').textContent = t.lblLang;
            document.getElementById('preview-label-date').textContent = t.lblDate;
            document.getElementById('preview-footer-project').textContent = `${t.pViact} - Generated with Capitalization Tool`;
            lucide.createIcons();
        }

        // --- Dynamic Sections System ---

        function renderSections() {
            const container = document.getElementById('dynamic-sections-container');
            container.innerHTML = '';

            sections.forEach((sec, index) => {
                const t = TRANSLATIONS[currentLang];
                let displayTitle = sec.customTitle || "Section";
                const helpText = sec.helpKey ? t[sec.helpKey] : t.helpDefault;
                
                let contentHTML = '';

                if (sec.contentType === 'image') {
                    const imgSrc = sec.content || '';
                    const hasImage = imgSrc.length > 0;
                    contentHTML = `
                        <div class="mb-3">
                            <p class="text-xs text-slate-500 mb-2 italic">${t.helpImage}</p>
                            <div class="flex flex-col gap-3">
                                <label class="flex items-center gap-2 px-4 py-3 bg-slate-50 hover:bg-slate-100 text-slate-600 rounded-lg cursor-pointer border border-slate-300 border-dashed transition-colors w-full justify-center">
                                    <i data-lucide="image-plus" class="w-5 h-5"></i>
                                    <span class="text-sm font-medium">Charger une image</span>
                                    <input type="file" accept="image/*" class="hidden" onchange="handleSectionImageUpload(${index}, this)">
                                </label>
                                ${hasImage ? `
                                    <div class="relative group rounded-lg overflow-hidden border border-slate-200 bg-slate-50">
                                        <img src="${imgSrc}" class="w-full h-48 object-contain">
                                        <button onclick="clearSectionContent(${index})" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="Supprimer">
                                            <i data-lucide="x" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                ` : ''}
                                <div class="mt-2">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">${t.lblCaption}</label>
                                    <input type="text" value="${sec.caption || ''}" oninput="updateSectionCaption(${index}, this.value)" class="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-indigo-500" placeholder="...">
                                </div>
                            </div>
                        </div>
                    `;
                } else if (sec.contentType === 'drawing') {
                    contentHTML = `
                         <div class="mb-3">
                            <p class="text-xs text-slate-500 mb-2 italic">${t.helpDrawing}</p>
                            <div class="bg-white border border-slate-300 rounded-lg overflow-hidden">
                                <div class="flex items-center gap-2 p-2 bg-slate-50 border-b border-slate-200 overflow-x-auto">
                                    <input type="color" id="draw-color-${index}" value="#1e1b4b" class="w-8 h-8 rounded cursor-pointer border-none bg-transparent shrink-0">
                                    <input type="range" id="draw-size-${index}" min="1" max="20" value="2" class="w-20 shrink-0">
                                    <div class="h-6 w-px bg-slate-200 mx-1 shrink-0"></div>
                                    <button onclick="setDrawTool(${index}, 'pen')" id="btn-tool-pen-${index}" class="p-1.5 bg-slate-200 rounded text-slate-700" title="Crayon">
                                        <i data-lucide="pencil" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="setDrawTool(${index}, 'line')" id="btn-tool-line-${index}" class="p-1.5 hover:bg-slate-200 rounded text-slate-600" title="Ligne">
                                        <i data-lucide="minus" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="setDrawTool(${index}, 'eraser')" id="btn-tool-eraser-${index}" class="p-1.5 hover:bg-slate-200 rounded text-slate-600" title="Gomme">
                                        <i data-lucide="eraser" class="w-4 h-4"></i>
                                    </button>
                                    <div class="h-6 w-px bg-slate-200 mx-1 shrink-0"></div>
                                    <button onclick="setDrawTool(${index}, 'rect')" id="btn-tool-rect-${index}" class="p-1.5 hover:bg-slate-200 rounded text-slate-600" title="Carré">
                                        <i data-lucide="square" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="setDrawTool(${index}, 'circle')" id="btn-tool-circle-${index}" class="p-1.5 hover:bg-slate-200 rounded text-slate-600" title="Cercle">
                                        <i data-lucide="circle" class="w-4 h-4"></i>
                                    </button>
                                     <button onclick="setDrawTool(${index}, 'text')" id="btn-tool-text-${index}" class="p-1.5 hover:bg-slate-200 rounded text-slate-600" title="Texte">
                                        <i data-lucide="type" class="w-4 h-4"></i>
                                    </button>
                                    <div class="flex-grow"></div>
                                    <button onclick="clearDrawingCanvas(${index})" class="p-1.5 hover:bg-red-100 text-red-500 rounded" title="Tout effacer">
                                        <i data-lucide="trash" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div class="relative w-full h-80 bg-white cursor-crosshair overflow-hidden">
                                    <canvas id="canvas-${index}" class="block touch-none"></canvas>
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="block text-xs font-bold text-slate-500 mb-1">${t.lblCaption}</label>
                                <input type="text" value="${sec.caption || ''}" oninput="updateSectionCaption(${index}, this.value)" class="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-indigo-500" placeholder="...">
                            </div>
                        </div>
                    `;
                } else {
                    contentHTML = `
                        <div>
                            <p class="text-xs text-slate-500 mb-2 italic">${helpText}</p>
                            <textarea rows="3" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 resize-none overflow-hidden" oninput="autoResize(this); updateSectionContent(${index}, this.value)">${sec.content}</textarea>
                        </div>
                    `;
                }

                const sectionHTML = `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 section-block group" data-index="${index}">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex-grow mr-4">
                                <input type="text" value="${displayTitle}" onchange="updateSectionTitle(${index}, this.value)" class="font-bold text-lg text-indigo-900 border-b border-transparent hover:border-slate-300 focus:border-indigo-500 focus:outline-none w-full bg-transparent transition-colors placeholder-indigo-300" placeholder="Titre de la section...">
                            </div>
                            <div class="flex items-center gap-1 opacity-100 lg:opacity-50 lg:group-hover:opacity-100 transition-opacity">
                                <button onclick="moveSection(${index}, -1)" class="p-2 hover:bg-slate-100 rounded text-slate-500" title="Monter"><i data-lucide="arrow-up" class="w-4 h-4"></i></button>
                                <button onclick="moveSection(${index}, 1)" class="p-2 hover:bg-slate-100 rounded text-slate-500" title="Descendre"><i data-lucide="arrow-down" class="w-4 h-4"></i></button>
                                <button onclick="deleteSection(${index})" class="p-2 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded ml-2" title="Supprimer"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        ${contentHTML}
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', sectionHTML);
            });
            
            lucide.createIcons();
            container.querySelectorAll('textarea').forEach(ta => autoResize(ta));
            sections.forEach((sec, index) => {
                if (sec.contentType === 'drawing') {
                    initCanvas(index);
                }
            });
        }

        // --- Canvas Drawing Logic ---
        
        let drawingStates = {}; 

        function initCanvas(index, preserveContent = false) {
            const canvas = document.getElementById(`canvas-${index}`);
            if (!canvas) return;

            const parent = canvas.parentElement;
            const rect = parent.getBoundingClientRect();
            
            // Set canvas buffer size to match display size
            const newWidth = rect.width;
            const newHeight = rect.height;

            if (canvas.width !== newWidth || canvas.height !== newHeight) {
                // If preserving, we need to handle content carefully. 
                // Simple version: just reset size and draw back the base64 content
                canvas.width = newWidth;
                canvas.height = newHeight;
                canvas.style.width = '100%';
                canvas.style.height = '100%';
            }

            const ctx = canvas.getContext('2d');
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Fill white if empty or reset
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Load existing content
            if (sections[index].content) {
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = sections[index].content;
            }

            if (!drawingStates[index]) {
                drawingStates[index] = { mode: 'pen' };
            }
            let startX = 0;
            let startY = 0;
            let snapshot = null;
            let isDrawing = false;

            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }

            function start(e) {
                // We don't preventDefault for text to allow interaction flow if needed, 
                // but generally for canvas drawing it's better to preventDefault to stop scrolling
                if(e.type !== 'touchstart') e.preventDefault();
                
                isDrawing = true;
                
                // Aspect Ratio Check before drawing
                const currentRect = canvas.getBoundingClientRect();
                if (canvas.width !== currentRect.width || canvas.height !== currentRect.height) {
                    const tempContent = canvas.toDataURL();
                    canvas.width = currentRect.width;
                    canvas.height = currentRect.height;
                    const img = new Image();
                    img.onload = () => {
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = "white";
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.src = tempContent;
                }

                const pos = getPos(e);
                startX = pos.x;
                startY = pos.y;
                
                const mode = drawingStates[index].mode;
                
                if (mode === 'rect' || mode === 'circle' || mode === 'line') {
                    snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
                } else if (mode === 'text') {
                    isDrawing = false; 
                    const text = prompt("Entrez votre texte :");
                    if (text) {
                        const sizeInput = document.getElementById(`draw-size-${index}`);
                        const colorInput = document.getElementById(`draw-color-${index}`);
                        ctx.font = `${sizeInput.value * 5 + 10}px Arial`;
                        ctx.fillStyle = colorInput.value;
                        ctx.textBaseline = 'middle'; // Fix text vertical align
                        ctx.fillText(text, pos.x, pos.y);
                        saveCanvas(index);
                    }
                } else {
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y);
                }
            }

            function move(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getPos(e);
                
                const colorInput = document.getElementById(`draw-color-${index}`);
                const sizeInput = document.getElementById(`draw-size-${index}`);
                const mode = drawingStates[index].mode;

                if (mode === 'pen' || mode === 'eraser') {
                    ctx.lineWidth = sizeInput.value;
                    if (mode === 'eraser') {
                        ctx.globalCompositeOperation = 'destination-out';
                        ctx.strokeStyle = "rgba(0,0,0,1)";
                        ctx.lineWidth = sizeInput.value * 5; 
                    } else {
                        ctx.globalCompositeOperation = 'source-over';
                        ctx.strokeStyle = colorInput.value;
                    }
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                } 
                else if (mode === 'line') {
                    ctx.putImageData(snapshot, 0, 0); 
                    ctx.beginPath();
                    ctx.lineWidth = sizeInput.value;
                    ctx.strokeStyle = colorInput.value;
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                }
                else if (mode === 'rect') {
                    ctx.putImageData(snapshot, 0, 0); 
                    ctx.beginPath();
                    ctx.lineWidth = sizeInput.value;
                    ctx.strokeStyle = colorInput.value;
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.strokeRect(startX, startY, pos.x - startX, pos.y - startY);
                }
                else if (mode === 'circle') {
                    ctx.putImageData(snapshot, 0, 0); 
                    ctx.beginPath();
                    ctx.lineWidth = sizeInput.value;
                    ctx.strokeStyle = colorInput.value;
                    ctx.globalCompositeOperation = 'source-over';
                    const radius = Math.sqrt(Math.pow(pos.x - startX, 2) + Math.pow(pos.y - startY, 2));
                    ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
                    ctx.stroke();
                }
            }

            function stop(e) {
                if (!isDrawing) return;
                isDrawing = false;
                if (drawingStates[index].mode !== 'text') {
                    saveCanvas(index);
                }
            }

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', stop);
            canvas.addEventListener('mouseout', stop);

            canvas.addEventListener('touchstart', start);
            canvas.addEventListener('touchmove', move);
            canvas.addEventListener('touchend', stop);
        }

        function setDrawTool(index, tool) {
            if (!drawingStates[index]) drawingStates[index] = {};
            drawingStates[index].mode = tool;
            
            const tools = ['pen', 'line', 'eraser', 'rect', 'circle', 'text'];
            tools.forEach(t => {
                const btn = document.getElementById(`btn-tool-${t}-${index}`);
                if (btn) {
                    if (t === tool) {
                        btn.classList.add('bg-slate-200');
                        btn.classList.remove('hover:bg-slate-200');
                    } else {
                        btn.classList.remove('bg-slate-200');
                        btn.classList.add('hover:bg-slate-200');
                    }
                }
            });
        }

        function clearDrawingCanvas(index) {
            const canvas = document.getElementById(`canvas-${index}`);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveCanvas(index);
        }

        function saveCanvas(index) {
            const canvas = document.getElementById(`canvas-${index}`);
            sections[index].content = canvas.toDataURL("image/png");
            updatePreview();
        }


        // --- Actions ---

        function updateSectionContent(index, value) {
            sections[index].content = value;
            updatePreview();
        }

        function updateSectionCaption(index, value) {
            sections[index].caption = value;
            updatePreview();
        }

        function updateSectionTitle(index, value) {
            sections[index].customTitle = value;
            updatePreview();
        }

        function moveSection(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= sections.length) return;
            const temp = sections[index];
            sections[index] = sections[newIndex];
            sections[newIndex] = temp;
            renderSections();
            updatePreview();
        }

        function deleteSection(index) {
            if(confirm("Supprimer cette section ?")) {
                sections.splice(index, 1);
                renderSections();
                updatePreview();
            }
        }

        function addNewSection(type) {
            const t = TRANSLATIONS[currentLang];
            let defaultTitle = t.btnAddText;
            if (type === 'image') defaultTitle = t.btnAddImage;
            if (type === 'drawing') defaultTitle = t.btnAddDrawing;
            
            sections.push({
                id: `custom-${Date.now()}`,
                customTitle: defaultTitle,
                content: "",
                caption: "",
                type: "normal",
                contentType: type,
                helpKey: type === 'image' ? 'helpImage' : (type === 'drawing' ? 'helpDrawing' : 'helpDefault')
            });
            renderSections();
            setTimeout(() => {
                const container = document.getElementById('dynamic-sections-container');
                container.lastElementChild.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function handleLogoUpload(input) {
            const file = input.files[0];
            const placeholder = document.getElementById('default-logo-placeholder');
            const img = document.getElementById('custom-logo-img');
            const filenameSpan = document.getElementById('logo-filename');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    filenameSpan.textContent = file.name;
                }
                reader.readAsDataURL(file);
            } else {
                img.src = '';
                img.classList.add('hidden');
                placeholder.classList.remove('hidden');
                filenameSpan.textContent = 'Aucun fichier';
            }
        }

        function handleSectionImageUpload(index, input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    sections[index].content = e.target.result; 
                    renderSections(); 
                    updatePreview();
                }
                reader.readAsDataURL(file);
            }
        }

        function clearSectionContent(index) {
            sections[index].content = '';
            renderSections();
            updatePreview();
        }

        // --- Preview Logic ---

        function updatePreview() {
            const title = document.getElementById('input-title').value;
            const author = document.getElementById('input-author').value;
            const date = document.getElementById('input-date').value;
            const type = document.getElementById('input-type').value;
            const langRes = document.getElementById('input-resource-lang').value;
            const location = document.getElementById('input-location').value;

            document.getElementById('preview-title').textContent = title || '...';
            document.getElementById('preview-title').className = title ? "text-3xl md:text-4xl font-extrabold text-slate-900 leading-tight break-words" : "text-3xl md:text-4xl font-extrabold text-slate-300 italic leading-tight break-words";
            
            document.getElementById('preview-location').textContent = location;
            document.getElementById('preview-location-container').style.display = location ? 'flex' : 'none';
            document.getElementById('preview-date-print').textContent = new Date().toLocaleDateString();
            document.getElementById('preview-author').textContent = author || '-';
            document.getElementById('preview-type').textContent = type || '-';
            document.getElementById('preview-resource-lang').textContent = langRes || '-';
            document.getElementById('preview-date').textContent = date || '-';

            const previewContainer = document.getElementById('preview-dynamic-content');
            previewContainer.innerHTML = '';

            const t = TRANSLATIONS[currentLang];

            sections.forEach(sec => {
                let title = sec.customTitle || "Section";
                let html = '';

                // HIDE EMPTY
                if (sec.contentType === 'image' || sec.contentType === 'drawing') {
                    if (!sec.content || sec.content.length === 0) return;
                } else {
                    if (!sec.content || sec.content.trim() === '') return;
                }

                if (sec.contentType === 'image' || sec.contentType === 'drawing') {
                    // PREVIEW IMAGE/DRAWING
                    html = `
                    <section class="break-inside-avoid">
                        <h3 class="text-lg font-bold text-indigo-900 mb-2 border-b border-indigo-100 pb-1">${title}</h3>
                        <div class="mt-3">
                            <img src="${sec.content}" class="max-w-full rounded-lg shadow-sm max-h-[500px] object-contain mx-auto bg-white border border-slate-100">
                            ${sec.caption ? `<p class="text-sm text-slate-500 mt-2 text-center italic">${sec.caption}</p>` : ''}
                        </div>
                    </section>
                    `;

                } else {
                    // PREVIEW TEXT
                    if (sec.type === 'box-orange') {
                        html = `
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-100 break-inside-avoid">
                            <h3 class="text-sm font-bold text-orange-800 mb-2 flex items-center gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4"></i> ${title}
                            </h3>
                            <p class="text-sm text-slate-700 whitespace-pre-wrap">${sec.content}</p>
                        </div>`;
                    } else if (sec.type === 'box-indigo') {
                        html = `
                        <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100 break-inside-avoid">
                            <h3 class="text-sm font-bold text-indigo-800 mb-2 flex items-center gap-2">
                                <i data-lucide="alert-triangle" class="w-4 h-4"></i> ${title}
                            </h3>
                            <p class="text-sm text-slate-700 italic whitespace-pre-wrap">${sec.content}</p>
                        </div>`;
                    } else if (sec.type === 'box-gray') {
                        html = `
                        <section class="bg-slate-50 p-5 rounded-xl border border-slate-100 break-inside-avoid">
                            <h3 class="text-lg font-bold text-indigo-900 mb-3">${title}</h3>
                            <p class="text-slate-700 leading-relaxed text-sm whitespace-pre-wrap">${sec.content}</p>
                        </section>`;
                    } else {
                        html = `
                        <section class="break-inside-avoid">
                            <h3 class="text-lg font-bold text-indigo-900 mb-2 border-b border-indigo-100 pb-1">${title}</h3>
                            <p class="text-slate-700 leading-relaxed text-sm whitespace-pre-wrap">${sec.content}</p>
                        </section>`;
                    }
                }

                previewContainer.insertAdjacentHTML('beforeend', html);
            });

            lucide.createIcons();
            updateFilename(date, langRes, title, author);
        }

        // --- Helpers ---
        
        function getInitials(name) {
            if (!name) return 'UNK';
            const parts = name.trim().split(/\s+/);
            if (parts.length === 1) return parts[0].substring(0, 3).toUpperCase();
            return (parts[0][0] + (parts[1] ? parts[1][0] : '')).toUpperCase();
        }

        function updateFilename(date, langRes, title, author) {
            const dateStr = date || 'NoDate';
            const cleanTitle = (title || 'Untitled')
                .replace(/[^a-zA-Z0-9à-ÿÀ-Ÿ\s-]/g, '')
                .trim()
                .replace(/\s+/g, '-')
                .substring(0, 40);
            
            const langCode = (langRes || currentLang).substring(0, 2).toUpperCase();
            const initials = getInitials(author);

            const fileName = `${dateStr}_${langCode}_${cleanTitle}_${initials}`;
            
            document.title = fileName;
            document.getElementById('filename-preview').textContent = `Fichier : ${fileName}.pdf`;
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function switchTab(tab) {
            const editCol = document.getElementById('editor-col');
            const previewCol = document.getElementById('preview-col');
            const btnEdit = document.getElementById('tab-edit');
            const btnPreview = document.getElementById('tab-preview');

            if (tab === 'edit') {
                editCol.classList.remove('hidden');
                editCol.classList.add('flex');
                previewCol.classList.add('hidden');
                btnEdit.classList.add('bg-indigo-600', 'text-white');
                btnEdit.classList.remove('bg-white', 'text-slate-600');
                btnPreview.classList.add('bg-white', 'text-slate-600');
                btnPreview.classList.remove('bg-indigo-600', 'text-white');
            } else {
                editCol.classList.add('hidden');
                editCol.classList.remove('flex');
                previewCol.classList.remove('hidden');
                previewCol.classList.add('block');
                btnPreview.classList.add('bg-indigo-600', 'text-white');
                btnPreview.classList.remove('bg-white', 'text-slate-600');
                btnEdit.classList.add('bg-white', 'text-slate-600');
                btnEdit.classList.remove('bg-indigo-600', 'text-white');
            }
        }
    </script>
</body>
</html>
